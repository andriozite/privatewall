<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Private Wall - Catatan Pribadi Real-time</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Plus+Jakarta+Sans', sans-serif;
        }
        .message-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .message-card:hover {
            transform: translateY(-4px);
        }
        #loading-screen {
            transition: opacity 0.5s ease-out;
        }
        .error-toast {
            animation: slideUp 0.3s ease-out forwards;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-rose-600 mb-4"></div>
        <p id="loading-text" class="text-slate-500 font-medium">Menghubungkan ke database pribadi...</p>
        <div id="setup-instruction" class="hidden mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl max-w-sm text-center">
            <p class="text-amber-800 text-sm mb-2 font-bold">⚠️ Masalah Koneksi</p>
            <p class="text-amber-700 text-xs">Pastikan Authentication (Anonymous) sudah diaktifkan di Firebase Console.</p>
        </div>
    </div>

    <!-- Header -->
    <nav class="bg-white border-b sticky top-0 z-10 p-4 shadow-sm">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-rose-600 p-1.5 rounded-lg text-white">
                    <i data-lucide="lock" size="20"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">Private Wall</h1>
            </div>
            <div class="flex items-center gap-2 text-xs font-mono text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg border">
                <i data-lucide="shield-check" size="12" class="text-green-600"></i>
                <span id="user-id">Authenticating...</span>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-8 w-full">
        <!-- Intro -->
        <section class="mb-10 text-center">
            <h2 class="text-4xl font-extrabold mb-3 text-slate-900">Jurnal Pribadi.</h2>
            <p class="text-slate-500 max-w-lg mx-auto italic text-lg leading-relaxed">
                Pesan di bawah ini hanya bisa dilihat oleh Anda. Aman, terenkripsi, dan privat.
            </p>
        </section>

        <!-- Form -->
        <form id="message-form" class="mb-12">
            <div class="flex flex-col sm:flex-row gap-3 bg-white p-3 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Tulis catatan rahasia atau pengingat..."
                    class="flex-1 p-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-100 text-lg transition-all"
                    maxlength="140"
                    required
                >
                <button
                    type="submit"
                    id="submit-btn"
                    class="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold hover:bg-black disabled:opacity-50 transition-all flex items-center justify-center gap-2 active:scale-95"
                >
                    <i data-lucide="save" size="18"></i>
                    Simpan
                </button>
            </div>
            <p class="mt-2 text-xs text-center text-slate-400 font-medium">
                Data disimpan secara eksklusif untuk akun Anda
            </p>
        </form>

        <!-- Wall Grid -->
        <div id="messages-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Messages will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden py-20 text-center border-2 border-dashed border-slate-200 rounded-3xl">
            <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="eye-off" class="text-slate-400"></i>
            </div>
            <h3 class="text-slate-600 font-bold">Belum ada catatan</h3>
            <p class="text-slate-400">Mulailah menulis sesuatu yang hanya untuk Anda.</p>
        </div>
    </main>

    <footer class="py-12 text-center mt-auto">
        <p class="text-slate-400 text-xs font-medium">
            <i data-lucide="shield" size="12" class="inline mr-1"></i> Terkoneksi ke Proyek: wallprojectandrian
        </p>
    </footer>

    <!-- Error Toast Container -->
    <div id="error-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi dari Anda
        const firebaseConfig = {
            apiKey: "AIzaSyBsyXGXtDFNX5SAk5MX-vX1_aPTN4rUJj0",
            authDomain: "wallprojectandrian.firebaseapp.com",
            projectId: "wallprojectandrian",
            storageBucket: "wallprojectandrian.firebasestorage.app",
            messagingSenderId: "868691739946",
            appId: "1:868691739946:web:64302322851757a4ca4a53",
            measurementId: "G-BHX3Z0V954"
        };

        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesGrid = document.getElementById('messages-grid');
        const emptyState = document.getElementById('empty-state');
        const userIdDisplay = document.getElementById('user-id');
        const loadingScreen = document.getElementById('loading-screen');
        const setupInstruction = document.getElementById('setup-instruction');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');

        let currentUser = null;
        let db, auth;
        const appId = 'private-wall-andrian';

        function showError(message) {
            const container = document.getElementById('error-container');
            const toast = document.createElement('div');
            toast.className = "error-toast pointer-events-auto bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm";
            toast.innerHTML = `<i data-lucide="alert-circle" size="18"></i> <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 5000);
        }

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autentikasi Anonim
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        userIdDisplay.textContent = "USER: " + user.uid.substring(0, 6);
                        hideLoading();
                        startListening();
                    }
                });

            } catch (err) {
                console.error("Initialization error:", err);
                loadingSpinner.classList.add('hidden');
                loadingText.textContent = "Koneksi Gagal";
                setupInstruction.classList.remove('hidden');
                showError("Gagal terhubung. Pastikan API Key benar dan Authentication aktif.");
            }
        }

        function hideLoading() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.style.display = 'none', 500);
        }

        function startListening() {
            if (!currentUser || !db) return;

            // Menggunakan path privat sesuai Rule 1
            const privateMessagesRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes');
            
            onSnapshot(privateMessagesRef, (snapshot) => {
                const msgs = [];
                snapshot.forEach((doc) => {
                    msgs.push({ id: doc.id, ...doc.data() });
                });

                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderMessages(msgs);
            }, (error) => {
                console.error("Firestore error:", error);
                showError("Masalah izin database. Cek Rules Firestore.");
            });
        }

        function renderMessages(msgs) {
            if (msgs.length === 0) {
                emptyState.classList.remove('hidden');
                messagesGrid.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            messagesGrid.innerHTML = msgs.map(msg => `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60 message-card flex flex-col animate-in fade-in zoom-in duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-slate-100 p-1.5 rounded-md text-slate-400">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                        </div>
                        <span class="text-[10px] uppercase font-bold tracking-wider text-slate-400">
                            ${msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleDateString() : 'Baru saja'}
                        </span>
                    </div>
                    <p class="text-md font-medium text-slate-700 break-words mb-4 leading-relaxed">
                        ${escapeHtml(msg.text)}
                    </p>
                    <div class="mt-auto pt-3 border-t border-slate-50 flex items-center justify-between">
                        <span class="text-[10px] font-bold text-slate-300 uppercase">Milik Anda</span>
                        <i data-lucide="lock" class="w-3 h-3 text-slate-200"></i>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentUser || !db) return;

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;

            try {
                const privateMessagesRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notes');
                await addDoc(privateMessagesRef, {
                    text: text,
                    createdAt: serverTimestamp(),
                });
                messageInput.value = '';
            } catch (err) {
                console.error("Gagal menyimpan:", err);
                showError("Gagal menyimpan. Cek aturan Firestore.");
            } finally {
                submitBtn.disabled = false;
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        initApp();
        lucide.createIcons();
    </script>
</body>
</html>